<!DOCTYPE html>
<html lang="en" dir="ltr">
<head><script src="/blog.github.io/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=blog.github.io/livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="
  注释篇
  #


  注释应说明代码不能表达的信息
  #

当函数内部逻辑过于复杂，我们可以用这种方式来避免阅读代码的人需要钻进函数的细节中，从而节省了阅读代码的时间，起到代码导读的作用。
Kubernetes 同步 Pod 循环比较复杂，所以通过函数注释的方式对方法进行说明

// syncLoopIteration reads from various channels and dispatches pods to the
// given handler.
//
// ......
// 
// With that in mind, in truly no particular order, the different channels
// are handled as follows:
//
//   - configCh: dispatch the pods for the config change to the appropriate
//     handler callback for the event type
//   - plegCh: update the runtime cache; sync pod
//   - syncCh: sync all pods waiting for sync
//   - housekeepingCh: trigger cleanup of pods
//   - health manager: sync pods that have failed or in which one or more
//     containers have failed health checks
func (kl *Kubelet) syncLoopIteration(ctx context.Context, configCh &lt;-chan kubetypes.PodUpdate, handler SyncHandler,
	syncCh &lt;-chan time.Time, housekeepingCh &lt;-chan time.Time, plegCh &lt;-chan *pleg.PodLifecycleEvent) bool {
}
注释最开头就解释了处理从各种渠道获取到的Pod信息并交给对应的处理逻辑，从注释中也总结了每个 channel 的大致处理逻辑。">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="http://localhost:1313/blog.github.io/docs/%E6%B3%A8%E9%87%8A%E7%AF%87/">
  <meta property="og:site_name" content="如何写好 Go">
  <meta property="og:title" content="注释篇">
  <meta property="og:description" content="注释篇#注释应说明代码不能表达的信息#当函数内部逻辑过于复杂，我们可以用这种方式来避免阅读代码的人需要钻进函数的细节中，从而节省了阅读代码的时间，起到代码导读的作用。
Kubernetes 同步 Pod 循环比较复杂，所以通过函数注释的方式对方法进行说明
// syncLoopIteration reads from various channels and dispatches pods to the // given handler. // // ...... // // With that in mind, in truly no particular order, the different channels // are handled as follows: // // - configCh: dispatch the pods for the config change to the appropriate // handler callback for the event type // - plegCh: update the runtime cache; sync pod // - syncCh: sync all pods waiting for sync // - housekeepingCh: trigger cleanup of pods // - health manager: sync pods that have failed or in which one or more // containers have failed health checks func (kl *Kubelet) syncLoopIteration(ctx context.Context, configCh &lt;-chan kubetypes.PodUpdate, handler SyncHandler, syncCh &lt;-chan time.Time, housekeepingCh &lt;-chan time.Time, plegCh &lt;-chan *pleg.PodLifecycleEvent) bool { } 注释最开头就解释了处理从各种渠道获取到的Pod信息并交给对应的处理逻辑，从注释中也总结了每个 channel 的大致处理逻辑。">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
<title>注释篇 | 如何写好 Go</title>
<link rel="manifest" href="/blog.github.io/manifest.json">
<link rel="icon" href="/blog.github.io/favicon.png" >
<link rel="canonical" href="http://localhost:1313/blog.github.io/docs/%E6%B3%A8%E9%87%8A%E7%AF%87/">
<link rel="stylesheet" href="/blog.github.io/book.min.309b7ed028807cdb68d8d61e26d609f48369c098dbf5e4d8c0dcf4cdf49feafc.css" integrity="sha256-MJt&#43;0CiAfNto2NYeJtYJ9INpwJjb9eTYwNz0zfSf6vw=" crossorigin="anonymous">
  <script defer src="/blog.github.io/fuse.min.js"></script>
  <script defer src="/blog.github.io/en.search.min.ac6e227887241d08182a07a496db2a9689c506cb5ba78f5b1e17c861a55914a8.js" integrity="sha256-rG4ieIckHQgYKgekltsqlonFBstbp49bHhfIYaVZFKg=" crossorigin="anonymous"></script>

  <script defer src="/blog.github.io/sw.min.e4ddcc263458367a236da27cde805b3b9df4c2597e4f179e82c38949a90085b7.js" integrity="sha256-5N3MJjRYNnojbaJ83oBbO530wll&#43;TxeegsOJSakAhbc=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/blog.github.io/"><span>如何写好 Go</span>
  </a>
</h2>


<div class="book-search hidden">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>







  
<ul>
  
  <li>
    <a href=""  target="_blank" rel="noopener">
        
      </a>
  </li>
  
</ul>







  <ul>
<li>
  <a href="/blog.github.io/docs/%E5%8F%98%E9%87%8F%E7%AF%87/">注释篇</a></li>
<li>
  <a href="/blog.github.io/docs/%E6%B3%A8%E9%87%8A%E7%AF%87/"class=active>变量篇</a></li>
<li>[性能优化篇]</li>
</ul>










</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/blog.github.io/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>注释篇</strong>

  <label for="toc-control">
    
    <img src="/blog.github.io/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#注释篇"><strong>注释篇</strong></a>
      <ul>
        <li>
          <ul>
            <li><a href="#注释应说明代码不能表达的信息"><strong>注释应说明代码不能表达的信息</strong></a></li>
            <li><a href="#不用的代码直接删掉而不是注释掉"><strong>不用的代码直接删掉，而不是注释掉</strong></a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="注释篇">
  <strong>注释篇</strong>
  <a class="anchor" href="#%e6%b3%a8%e9%87%8a%e7%af%87">#</a>
</h1>
<h3 id="注释应说明代码不能表达的信息">
  <strong>注释应说明代码不能表达的信息</strong>
  <a class="anchor" href="#%e6%b3%a8%e9%87%8a%e5%ba%94%e8%af%b4%e6%98%8e%e4%bb%a3%e7%a0%81%e4%b8%8d%e8%83%bd%e8%a1%a8%e8%be%be%e7%9a%84%e4%bf%a1%e6%81%af">#</a>
</h3>
<p>当函数内部逻辑过于复杂，我们可以用这种方式来避免阅读代码的人需要钻进函数的细节中，从而节省了阅读代码的时间，<strong>起到代码导读的作用</strong>。</p>
<p><code>Kubernetes</code> 同步 <code>Pod</code> 循环比较复杂，所以通过函数注释的方式对方法进行说明</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// syncLoopIteration reads from various channels and dispatches pods to the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// given handler.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// ......
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// With that in mind, in truly no particular order, the different channels
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// are handled as follows:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   - configCh: dispatch the pods for the config change to the appropriate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//     handler callback for the event type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   - plegCh: update the runtime cache; sync pod
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   - syncCh: sync all pods waiting for sync
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   - housekeepingCh: trigger cleanup of pods
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//   - health manager: sync pods that have failed or in which one or more
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//     containers have failed health checks
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">kl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Kubelet</span>) <span style="color:#a6e22e">syncLoopIteration</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">configCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">PodUpdate</span>, <span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">SyncHandler</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">syncCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>, <span style="color:#a6e22e">housekeepingCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>, <span style="color:#a6e22e">plegCh</span> <span style="color:#f92672">&lt;-</span><span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pleg</span>.<span style="color:#a6e22e">PodLifecycleEvent</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>注释最开头就解释了处理从各种渠道获取到的Pod信息并交给对应的处理逻辑，从注释中也总结了每个 <code>channel</code> 的大致处理逻辑。</p>
<p>如果代码不是特别复杂，意思也可以通过代码表达出来，没必要写在注释上。</p>
<p>下面的例子，用户签到后普通VIP则加基础的10分，是VIP用户则额外增加100分。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">basePoints</span>  = <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">vipBonus</span>    = <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">User</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">IsVIP</span>    <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Points</span>   <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SignIn 处理用户签到并根据是否是 VIP 增加积分
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">u</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">User</span>) <span style="color:#a6e22e">SignIn</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">pointsToAdd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">basePoints</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">IsVIP</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pointsToAdd</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">vipBonus</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Points</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">pointsToAdd</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在代码中已经可以看到函数的意图，且代码逻辑比较简单，无需在上面添加注释。</p>
<p>同时，<strong>在业务尚未稳定时，尽量只给关键的、可能会产生歧义的操作添加注释即可</strong>。因为在业务频繁变动的过程中，如果内部逻辑做了修改，注释却没有同步修改，那么就会给人造成误导。</p>
<p>但是如果代码逻辑过分复杂，我们也**可以通过将代码抽层拆解来替代指引性注释。**我们来看一个 <code>Kubelet</code> 处理配置信号（ <code>configCh</code> ）的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">kl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Kubelet</span>) <span style="color:#a6e22e">syncLoopIteration</span>(<span style="color:#f92672">...</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">open</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">configCh</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Op</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">ADD</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">InfoS</span>(<span style="color:#e6db74">&#34;SyncLoop ADD&#34;</span>, <span style="color:#e6db74">&#34;source&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#e6db74">&#34;pods&#34;</span>, <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">KObjSlice</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodAdditions</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">UPDATE</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">InfoS</span>(<span style="color:#e6db74">&#34;SyncLoop UPDATE&#34;</span>, <span style="color:#e6db74">&#34;source&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#e6db74">&#34;pods&#34;</span>, <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">KObjSlice</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodUpdates</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">REMOVE</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">InfoS</span>(<span style="color:#e6db74">&#34;SyncLoop REMOVE&#34;</span>, <span style="color:#e6db74">&#34;source&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#e6db74">&#34;pods&#34;</span>, <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">KObjSlice</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodRemoves</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">RECONCILE</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">InfoS</span>(<span style="color:#e6db74">&#34;SyncLoop RECONCILE&#34;</span>, <span style="color:#e6db74">&#34;source&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#e6db74">&#34;pods&#34;</span>, <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">KObjSlice</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodReconcile</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">DELETE</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">InfoS</span>(<span style="color:#e6db74">&#34;SyncLoop DELETE&#34;</span>, <span style="color:#e6db74">&#34;source&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#e6db74">&#34;pods&#34;</span>, <span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">KObjSlice</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>))
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodUpdates</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">SET</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// TODO: Do we want to support this?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">ErrorS</span>(<span style="color:#66d9ef">nil</span>, <span style="color:#e6db74">&#34;Kubelet does not support snapshot update&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">ErrorS</span>(<span style="color:#66d9ef">nil</span>, <span style="color:#e6db74">&#34;Invalid operation type received&#34;</span>, <span style="color:#e6db74">&#34;operation&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Op</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>	
</span></span></code></pre></div><p>通过将每种事件的操作抽象成一个方法，可以避免平铺在 <code>switch</code> 逻辑分支下。</p>
<p>例如将 <code>kubetypes.ADD</code> 则对应的操作封装在 <code>HandlePodAdditions</code> 方法里面，让整体的代码看起来更加像一个目录。</p>
<p>如果我们想了解添加 Pod 的流程，则直接跳进 <code>HandlePodAdditions</code> 方法即可。</p>
<p>我们再看一个 <code>Kubernetes</code> 中 <code>BoundedFrequencyRunner</code>  的 <code>Run</code>  方法注释的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Run the function as soon as possible.  If this is called while Loop is not
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// running, the call may be deferred indefinitely.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// If there is already a queued request to call the underlying function, it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// may be dropped - it is just guaranteed that we will try calling the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// underlying function as soon as possible starting from now.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">bfr</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">BoundedFrequencyRunner</span>) <span style="color:#a6e22e">Run</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">bfr</span>.<span style="color:#a6e22e">run</span> <span style="color:#f92672">&lt;-</span> <span style="color:#66d9ef">struct</span>{}{}:
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这里<strong>通过注释告诉了我们在这个方法本身看不到的点</strong></p>
<ol>
<li>如果 <code>Loop</code> 没有被调用，<strong>那么这个执行的信号将会无限期的被延期</strong>，因为并没有消费者能够去处理信号</li>
<li>如果已经有另一个地方调用了 <code>Run</code> ，<strong>我们的执行信号可能会被丢失</strong>，这个方法是尽可能现在开始运行一次任务</li>
</ol>
<p><strong>这两个信息都是我们单独看函数内容没办法直接看到的</strong>，作者将这些隐藏的内容通过注释的方式告诉我们，让我们能够快速了解这个方法使用需要注意的事项。</p>
<p>我们看一个正则表达式编译的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ExecRegex</span>(<span style="color:#a6e22e">value</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">regex</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">regex</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">decodeUnicode</span>(<span style="color:#a6e22e">regex</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">regex</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">regexp</span>.<span style="color:#a6e22e">MustCompile</span>(<span style="color:#a6e22e">regex</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rx</span>.<span style="color:#a6e22e">MatchString</span>(<span style="color:#a6e22e">value</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这里我们可以看到传入的正则表达式还被进行了一次 <code>decodeUnicode</code> 的处理，我们来看下具体的方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">decodeUnicode</span>(<span style="color:#a6e22e">inputString</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">re</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">regexp</span>.<span style="color:#a6e22e">MustCompile</span>(<span style="color:#e6db74">`\\u[0-9a-fA-F]{4}`</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">matches</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">re</span>.<span style="color:#a6e22e">FindAllString</span>(<span style="color:#a6e22e">inputString</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">match</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">matches</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">unquoted</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Unquote</span>(<span style="color:#e6db74">`&#34;`</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">match</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">`&#34;`</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">inputString</span> = <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Replace</span>(<span style="color:#a6e22e">inputString</span>, <span style="color:#a6e22e">match</span>, <span style="color:#a6e22e">unquoted</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">inputString</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>单看这个方法，我们只能知道这个方法对传入的表达式进行了转义，但是却不知道为什么需要转义，不转义会出现什么情况，令后来者一头雾水。我们在这个方法上加上对应的注释重新来看一下。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// decodeUnicode 对正则字符串进行转义，避免传入识别中文的正则[\\u4e00-\\u9fa5]时出现panic。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">decodeUnicode</span>(<span style="color:#a6e22e">inputString</span> <span style="color:#66d9ef">string</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>这个时候我们就一目了然了，因为 <code>Go</code> 在解析中文正则表达式的时候，如果不对正则字符串进行转义，会在传入识别中文的正则时出现 <code>panic</code> 。</p>
<p>这一行注释不仅让看代码的人马上了解了 <code>decode</code> 的意图，还让后来的人不会随意对转义后的字符串随意进行处理引入新的BUG。</p>
<p><strong>在代码中，变量名和注释是最接近自然语言的内容，所以这部分也是最容易理解的，我们对这部分的内容如果认真斟酌后再去写，可读性自然会有立竿见影的提升。</strong></p>
<p>空行实际上也是一种注释，它对代码进行了逻辑上的分割，相当于告诉读代码的人，这里的逻辑已经告一段落。</p>
<p>在上述<code>decodeUnicode</code> 方法中，我们也用了空行将需要预处理的匹配正则、具体的处理循环和最终的返回语句，在视觉上分割成了三段，使得代码更加直观清晰。</p>
<p>我们来看 <code>kubernetes</code> 中  <code>graceTerminateRSList</code>  判断 <code>RS</code> 是否存在的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">q</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">graceTerminateRSList</span>) <span style="color:#a6e22e">exist</span>(<span style="color:#a6e22e">uniqueRS</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">listItem</span>, <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">list</span>[<span style="color:#a6e22e">uniqueRS</span>]; <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rs</span>, <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这里在加锁和解锁的逻辑结束的时候就增加了空行，表名加锁的动作告一段落，接下来是判断是否存在的逻辑，让<strong>代码逻辑从视觉上就隔开了</strong>，我们需要关心的更多是下半部分的逻辑判断，<strong>能帮助我们快速抓住代码重点</strong>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">q</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">graceTerminateRSList</span>) <span style="color:#a6e22e">exist</span>(<span style="color:#a6e22e">uniqueRS</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">listItem</span>, <span style="color:#66d9ef">bool</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">rs</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">q</span>.<span style="color:#a6e22e">list</span>[<span style="color:#a6e22e">uniqueRS</span>]; <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rs</span>, <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>如果将空行去掉，跳进代码之后，我们很难就一眼看到这个方法的重点。</p>
<h3 id="不用的代码直接删掉而不是注释掉">
  <strong>不用的代码直接删掉，而不是注释掉</strong>
  <a class="anchor" href="#%e4%b8%8d%e7%94%a8%e7%9a%84%e4%bb%a3%e7%a0%81%e7%9b%b4%e6%8e%a5%e5%88%a0%e6%8e%89%e8%80%8c%e4%b8%8d%e6%98%af%e6%b3%a8%e9%87%8a%e6%8e%89">#</a>
</h3>
<p>我们大部分时候注释掉是希望未来还能再去掉注释用起来方便。</p>
<p>但还有另外一种情况，在未来某一个时间需要用，先暂时注释，等过段时间恢复之后，<strong>发现跟原来的代码不兼容，反而产生了BUG ，还需要重新去编写。</strong></p>
<p>这个时候我们<strong>不如一开始就把代码删掉</strong>，如果未来某个时刻需要重新用的话，可以通过 <code>git commit</code> 记录来找到以前被改掉的代码，重新进行编写。这个时候我们进行测试，也能对之前的代码进行优化，<strong>而不是被一大堆无用的注释代码干扰我们的阅读。</strong></p>
<p>这个原则在编写 <code>Kubernetes</code> 的yaml文件的时候同样适用</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># ...</span>
</span></span><span style="display:flex;"><span>			<span style="color:#75715e"># 挂载一个名为server-conf的configMap卷</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#  - name: server-conf-map</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#    configMap:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#      name: server-conf-map</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#      items:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#        - key: k8s-conf.yml</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#          path: k8s-conf.yml</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">#      defaultMode: 511</span>
</span></span></code></pre></div><p>这种在看 <code>yaml</code> 的定义时，就会被大段的无用注释给打断，如果 <code>server-conf-map</code> 已经被删除了的话，那这个注释就更加令人疑惑了。<strong>所以我们自己项目中没有被外部依赖的的代码，则直接删掉，等有需要的时候在借助 <code>git</code> 工具去找回。</strong></p>
<p>当我们项目中，有被第三方依赖的代码时，增加「弃用」注释可能是比删除更好的方法。有一些时候我们<strong>提供了一些包给第三方使用，如果我们</strong>直接删掉代码的话，调用方一旦升级了新的代码包时，就会产生大量报错，这个时候就需要先引导使用方去使用最新的代码。</p>
<p>所以我们可以给方法加上 <code>Deprecated</code> 注释，<strong>注明用什么来替代，传入什么参数</strong>。我们来看 <code>gprc</code> 中 <code>WithInsecure</code> 方法的弃用注释：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// Deprecated: use WithTransportCredentials and insecure.NewCredentials()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// instead. Will be supported throughout 1.x.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WithInsecure</span>() <span style="color:#a6e22e">DialOption</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">newFuncDialOption</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">o</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">dialOptions</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">o</span>.<span style="color:#a6e22e">copts</span>.<span style="color:#a6e22e">TransportCredentials</span> = <span style="color:#a6e22e">insecure</span>.<span style="color:#a6e22e">NewCredentials</span>()
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>可以看到这个注释明确告诉我们要用什么方法进行代替，并且由于 <code>WithTransportCredentials</code> 的方法是需要传入参数的，作者将对应的参数也告诉我们该如何传入。</p>
<p>这样我们在替换新方法的时候就会非常方便，也能更好的引导使用方用上我们新增加的特性。</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#注释篇"><strong>注释篇</strong></a>
      <ul>
        <li>
          <ul>
            <li><a href="#注释应说明代码不能表达的信息"><strong>注释应说明代码不能表达的信息</strong></a></li>
            <li><a href="#不用的代码直接删掉而不是注释掉"><strong>不用的代码直接删掉，而不是注释掉</strong></a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












